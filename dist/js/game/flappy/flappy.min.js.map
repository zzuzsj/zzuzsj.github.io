{"version":3,"sources":["js/game/flappy/flappy.js"],"names":["Flappy","this","_stageW","_stageH","_moveV","_accelertV","_addYV","_startX","_startY","_birdScaleW","_birdScaleH","_pipeW","_pipeSpace","prototype","bindStage","that","_stage","Konva","Stage","width","height","container","listening","_layer","Layer","add","addStart","on","text","getIntersection","getPointerPosition","_startText","init","gameStart","_overText","removeChildren","_startYV","_birdYV","_useTime","_pipeArr","_requestId","_passedNum","_totalText","uninit","Text","fill","fontStyle","fontSize","fontFamily","tw","th","x","y","batchDraw","addOver","_total","tow","toh","createBird","passNumChange","destroy","step","createPipe","pipeMove","birdDrop","requestAnimationFrame","hitJudge","$","birdJump","gameOver","window","cancelAnimationFrame","logo","Image","src","_flappyBird","name","onload","image","total","upH","Math","floor","random","lowH","pipe","Group","upY","lowY","push","pipeUp","Rect","pipeLow","length","i","splice","curPipe","curx","getAttr","birdTY","birdBY"],"mappings":"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","file":"flappy.min.js","sourcesContent":["(function () {\r\n    function Flappy() {\r\n        this._stageW = 600;\r\n        this._stageH = 400;\r\n\r\n        this._moveV = 5;\r\n        this._accelertV = -0.35;\r\n        this._addYV = 6;\r\n        this._startX = 100;\r\n        this._startY = 150;\r\n        this._birdScaleW = 50;\r\n        this._birdScaleH = 50;\r\n        this._pipeW = 60;\r\n        this._pipeSpace = 300;\r\n    };\r\n\r\n    Flappy.prototype = {\r\n        bindStage: function () {\r\n            var that = this;\r\n            that._stage = new Konva.Stage({\r\n                width: that._stageW,\r\n                height: that._stageH,\r\n                container: 'contentDiv',\r\n                listening: true\r\n            });\r\n            that._layer = new Konva.Layer();\r\n            that._stage.add(that._layer);\r\n            that.addStart();\r\n            that._stage.on('click', function () {\r\n                var text = that._layer.getIntersection(that._stage.getPointerPosition(), 'Text');\r\n                if (!text) {\r\n                    return;\r\n                };\r\n                if (text == that._startText) {\r\n                    that.init();\r\n                    that.gameStart();\r\n                } else if (text == that._overText) {\r\n                    that._stage.removeChildren();\r\n                    that._layer = new Konva.Layer();\r\n                    that._stage.add(that._layer);\r\n                    that.init();\r\n                    that.gameStart();\r\n                };\r\n            });\r\n        },\r\n        init: function () {\r\n            this._startYV = 0;\r\n            this._birdYV = 0;\r\n            this._useTime = 0;\r\n            this._pipeArr = [];\r\n            this._requestId = null;\r\n            this._passedNum = 0;\r\n            this._totalText = null;\r\n        },\r\n        uninit: function () {\r\n            this._startYV = 0;\r\n            this._birdYV = 0;\r\n            this._useTime = 0;\r\n            this._requestId = null;\r\n            this._passedNum = 0;\r\n            this._totalText = null;\r\n            this._pipeArr = [];\r\n        },\r\n        addStart: function () {\r\n            var that = this;\r\n            that._startText = new Konva.Text({\r\n                text: 'Game Start',\r\n                fill: 'rgb(168,120,79)',\r\n                fontStyle: 'bold',\r\n                fontSize: 30,\r\n                fontFamily: 'Times New Roman'\r\n            });\r\n            var tw = that._startText.width();\r\n            var th = that._startText.height();\r\n            that._startText.x(that._stageW / 2 - tw / 2);\r\n            that._startText.y(that._stageH / 2 - th / 2);\r\n            that._layer.add(that._startText);\r\n            that._layer.batchDraw();\r\n        },\r\n        addOver: function () {\r\n            var that = this;\r\n            that._total = new Konva.Text({\r\n                text: 'Your Score:' + that._passedNum,\r\n                fill: 'rgb(64,120,255)',\r\n                fontStyle: 'bold',\r\n                fontSize: 30,\r\n                fontFamily: 'Times New Roman'\r\n            });\r\n            var tow = that._total.width();\r\n            var toh = that._total.height();\r\n            that._total.x(that._stageW / 2 - tow / 2);\r\n            that._total.y(that._stageH / 2 - toh / 2 - 20);\r\n            that._overText = new Konva.Text({\r\n                text: 'Restart',\r\n                fill: 'rgb(168,120,79)',\r\n                fontStyle: 'bold',\r\n                fontSize: 30,\r\n                fontFamily: 'Times New Roman'\r\n            });\r\n            var tw = that._overText.width();\r\n            var th = that._overText.height();\r\n            that._overText.x(that._stageW / 2 - tw / 2);\r\n            that._overText.y(that._stageH / 2 + th / 2 - 20);\r\n            that._layer.add(that._total);\r\n            that._layer.add(that._overText);\r\n            that._layer.batchDraw();\r\n        },\r\n        gameStart: function () {\r\n            var that = this;\r\n            that._stage.listening(false);\r\n            that.createBird();\r\n            that.passNumChange();\r\n            if (that._startText) {\r\n                that._startText.destroy();\r\n                that._startText = null;\r\n            } else {\r\n                that._total.destroy();\r\n                that._overText.destroy();\r\n                that._overText = null;\r\n                that._total = null;\r\n            };\r\n            var step = function () {\r\n                that._useTime++;\r\n                if (that._useTime % 60 == 0) {\r\n                    that.createPipe();\r\n                };\r\n                that.pipeMove();\r\n                that.birdDrop();\r\n                that._layer.batchDraw();\r\n                that._requestId = requestAnimationFrame(step);\r\n                that.hitJudge();\r\n            };\r\n            step();\r\n            $('#contentDiv').on('click', function () {\r\n                that.birdJump();\r\n            });\r\n        },\r\n        gameOver: function () {\r\n            var that = this;\r\n            window.cancelAnimationFrame(that._requestId);\r\n            that._stage.listening(true);\r\n            that.addOver();\r\n            that.uninit();\r\n        },\r\n        passNumChange: function () {\r\n            var that = this;\r\n            if (that._passedNum == 0) {\r\n                that._totalText = new Konva.Text({\r\n                    fontSize: 20,\r\n                    fill: '#333',\r\n                    x: 20,\r\n                    y: 20,\r\n                    text: \"Total:\" + that._passedNum\r\n                });\r\n                that._layer.add(that._totalText);\r\n                that._layer.batchDraw();\r\n            } else {\r\n                that._totalText.text(\"Total:\" + that._passedNum);\r\n                that._layer.batchDraw();\r\n            };\r\n        },\r\n        createBird: function () {\r\n            var that = this;\r\n            var logo=new Image();\r\n            logo.src=\"./res/game/flappy/LOGO.png\";\r\n            that._flappyBird = new Konva.Image({\r\n                width: that._birdScaleW,\r\n                height: that._birdScaleH,\r\n                x: that._startX,\r\n                y: that._startY,\r\n                name: 'bird'\r\n            });\r\n            logo.onload=function(){\r\n                that._flappyBird.image(logo);\r\n                that._layer.batchDraw();\r\n            };\r\n            that._layer.add(that._flappyBird);\r\n            that._layer.batchDraw();\r\n        },\r\n        birdDrop: function () {\r\n            var that = this;\r\n            that._flappyBird.y(that._flappyBird.y() - that._birdYV);\r\n            that._birdYV += that._accelertV;\r\n        },\r\n        birdJump: function () {\r\n            this._birdYV = this._addYV;\r\n        },\r\n        createPipe: function () {\r\n            var total = this._stageH - 130;\r\n            var upH = Math.floor(Math.random() * (this._stageH - 200)) + 20;\r\n            var lowH = total - upH;\r\n            var that = this;\r\n            var pipe = new Konva.Group({\r\n                x: that._stageW,\r\n                y: 0,\r\n                width: that._pipeW,\r\n                height: that._stageH,\r\n                name: 'pipeGroup',\r\n                upY: upH,\r\n                lowY: that._stageH - lowH\r\n            });\r\n            that._pipeArr.push(pipe);\r\n            var pipeUp = new Konva.Rect({\r\n                width: this._pipeW,\r\n                height: upH,\r\n                x: 0,\r\n                y: 0,\r\n                fill: 'green'\r\n            });\r\n            var pipeLow = new Konva.Rect({\r\n                width: this._pipeW,\r\n                height: lowH,\r\n                x: 0,\r\n                y: that._stageH - lowH,\r\n                fill: 'green'\r\n            });\r\n            pipe.add(pipeUp);\r\n            pipe.add(pipeLow);\r\n            that._layer.add(pipe);\r\n            that._layer.batchDraw();\r\n        },\r\n        pipeMove: function () {\r\n            var that = this;\r\n            if (that._pipeArr.length == 0) {\r\n                return;\r\n            };\r\n            for (var i = 0; i < that._pipeArr.length; i++) {\r\n                (function (i) {\r\n                    var pipe = that._pipeArr[i];\r\n                    pipe.x(pipe.x() - that._moveV);\r\n                    if ((pipe.x() + that._pipeW) == that._startX) {\r\n                        that._passedNum++;\r\n                        that.passNumChange();\r\n                    } else if (pipe.x() < -that._pipeW) {\r\n                        pipe.destroy();\r\n                        that._pipeArr.splice(0, 1);\r\n                        return;\r\n                    }\r\n                })(i);\r\n            }\r\n        },\r\n        hitJudge: function () {\r\n            var that = this;\r\n            if (that._pipeArr.length == 0) {\r\n                return;\r\n            };\r\n            var curPipe = that._pipeArr[0];\r\n            var curx = curPipe.x();\r\n            if ((curx > (that._startX + that._birdScaleW)) || ((curx + that._pipeW) < that._startX)) {\r\n                return;\r\n            };\r\n            var upY = curPipe.getAttr('upY');\r\n            var lowY = curPipe.getAttr('lowY');\r\n            var birdTY = that._flappyBird.y();\r\n            var birdBY = that._flappyBird.y() + that._birdScaleH;\r\n            if ((birdTY < upY) || birdBY > lowY) {\r\n                if (that._requestId) {\r\n                    that.gameOver();\r\n                };\r\n            };\r\n        }\r\n    };\r\n\r\n    window.Flappy = Flappy;\r\n\r\n})();"]}